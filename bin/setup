#!/usr/bin/env ruby
require 'pathname'
require 'fileutils'
include FileUtils

PROJECT_ROOT = Pathname.new File.expand_path('../../', __FILE__)

def system!(*args)
  system(*args) || abort("\n== Command #{args} failed ==")
end

def personal_files
  %w(
    .envrc
    data/*
    development/images/favicon.xcf
    README.md (badges)
    source/files/MichelleZhangResume.pdf
    source/google9c723a7692fdf206.html
    source/images/favicon.ico
    source/keybase.txt
    source/mywot116d689c1efc0de389b9.html
  )
end

def pretty_personal_files
  "\n\t#{personal_files.join("\n\t")}\n"
end

chdir PROJECT_ROOT do
  puts "\n== Installing Homebrew packages =="
  system! %(
    brew tap Homebrew/bundle
    brew bundle
  )

  puts "\n== Configure environment variables =="
  system! %(
    cp .envrc.sample .envrc
    direnv allow
  )

  puts "\n== Install & Configure ruby and ruby gems =="
  system! %{
    rbenv install -s $(cat ./.ruby-version)
    rbenv global $(cat ./.ruby-version)

    gem update --system
    gem install bundler
    rbenv rehash

    bundle install
  }

  puts "\n== Install & Configure node and node modules =="
  system! %{
    nodenv install -s $(cat ./.node-version)
    nodenv global $(cat ./.node-version)

    npm install
  }

  puts "\n== Installing git hooks =="
  system! %(
    bundle exec overcommit --install
    bundle exec overcommit --sign
  )

  puts "\nDon't forget to update #{pretty_personal_files} with your personal/project information!"

  puts "\n== Setup finished! =="
end
